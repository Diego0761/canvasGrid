<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Canvas Grid</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
      }

      .info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgb(7, 7, 7);
        padding: 5px;
        border-radius: 5px;
        font-family: Arial, san s-serif;
        font-size: 22px;
        display: flex;
        flex-direction: column;
      }

      span {
        color: white;
      }

      #clear {
        margin-top: 10px;
        padding: 10px 20px;
        background: #444;
        color: white;
        font-size: 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        position: absolute;
        top: 15px;
        right: 15px;
      }

      nav {
        display: flex;
        background-color: #fff4c4;
        height: 100px;
        justify-content: center;
        align-items: center;
        gap: 12px;
      }

      nav > button {
        background-color: white;
        border: none;
        color: white;
        font-size: 24px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px;
        border: 2px solid transparent;
      }

      nav > button.selected {
        border: 2px solid rgb(252, 125, 125);
      }

      nav > button:hover {
        background-color: #eeeeee;
      }

      .icons {
        width: 48px;
        height: 48px;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"> </canvas>

    <nav>
      <button id="move" class="selected">
        <img class="icons" src="assets/arrows-out-cardinal.svg" alt="move" />
      </button>

      <button id="paint">
        <img class="icons" src="assets/paint-brush.svg" alt="paint" />
      </button>
    </nav>

    <div class="info">
      <span id="mouseXY">mouse X, Y: [0, 0] </span>
      <span id="startXY">start X, Y = [0, 0]</span>
      <span id="originPosXY">origin X, Y = [0, 0]</span>
      <span id="globalMousePosXY">global Mouse X, Y = [0, 0]</span>
    </div>

    <button id="clear" onclick="clearGrid()">clear</button>

    <script>
      const buttons = [
        document.getElementById('move'),
        document.getElementById('paint')
      ]
      let selectedButton = buttons[0]

      buttons.forEach(button => {
        button.addEventListener('click', () => {
          if (button.id === 'move') {
            move = true
            paint = false
            erase = false
          } else if (button.id === 'paint') {
            move = false
            paint = true
            erase = false
          }
          selectedButton.classList.remove('selected')
          button.classList.add('selected')
          selectedButton = button
        })
      })

      let originPos = { x: 0, y: 0 }

      let paint = false
      let erase = false
      let move = true

      let lastMouse = { x: 0, y: 0 }

      let globalMousePos = { x: 0, y: 0 }

      let startOrigin = { x: 0, y: 0 }

      let gridSize = 32

      let square = {
        worldX: 1024,
        worldY: 512,
        setChunk(chunk) {
          this.worldX = chunk.x * gridSize
          this.worldY = chunk.y * gridSize
        },
        size: gridSize
      }

      let coloredChunks =
        JSON.parse(localStorage.getItem('coloredChunks')) || []

      function paintChunk({ x, y }) {
        const chunk = coloredChunks.some(
          chunk => chunk.x === x && chunk.y === y
        )
        if (!chunk) {
          coloredChunks.push({
            x: x,
            y: y
          })
          console.log('Painted chunk at:', x, y)
          console.log('Colored Chunks:', coloredChunks)
        }

        localStorage.setItem('coloredChunks', JSON.stringify(coloredChunks))
      }

      function getChunkFromWorldPos(x, y) {
        console.log('Get chunk from world pos:', x, y)

        return {
          x: Math.floor(x / gridSize),
          y: Math.floor(y / gridSize)
        }
      }

      function clearGrid() {
        coloredChunks = []
        localStorage.removeItem('coloredChunks')
        drawGrid()
        console.log('Cleared grid and localStorage')
      }

      function Erase() {
        erase = true

        const chunk = getChunkFromWorldPos(globalMousePos.x, globalMousePos.y)

        if (coloredChunks.some(c => c.x === chunk.x && c.y === chunk.y)) {
          coloredChunks = coloredChunks.filter(
            c => !(c.x === chunk.x && c.y === chunk.y)
          )
          console.log('Erased chunk at:', chunk.x, chunk.y)
          localStorage.setItem('coloredChunks', JSON.stringify(coloredChunks))
          drawGrid()
        }
      }

      square.setChunk({ x: 16, y: 16 })

      let mouseState = 'off'

      const canvas = document.getElementById('canvas')
      const ctx = canvas.getContext('2d')

      let startX, startY

      function drawGrid() {
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight - 100

        ctx.clearRect(0, 0, canvas.width, canvas.height)
        ctx.strokeStyle = '#00000033'

        for (chunk in coloredChunks) {
          const c = coloredChunks[chunk]
          ctx.fillRect(
            c.x * gridSize + originPos.x,
            c.y * gridSize + originPos.y,
            gridSize,
            gridSize
          )
        }

        startX = (originPos.x % gridSize) - gridSize
        startY = (originPos.y % gridSize) - gridSize

        for (let x = startX; x <= canvas.width; x += gridSize) {
          ctx.beginPath()
          ctx.moveTo(x, 0)
          ctx.lineTo(x, canvas.height)
          ctx.stroke()
        }

        for (let y = startY; y <= canvas.height; y += gridSize) {
          ctx.beginPath()
          ctx.moveTo(0, y)
          ctx.lineTo(canvas.width, y)
          ctx.stroke()
        }
      }

      // -----

      canvas.addEventListener('mousedown', e => {
        mouseState = 'on'

        if (selectedButton.id === 'paint') {
        }

        if (e.button === 2) {
          erase = true
        }
        if (e.button === 0) {
          paint = true
        }

        console.log('Mouse Down at:', e.clientX, e.clientY)
        lastMouse.x = e.clientX
        lastMouse.y = e.clientY
        startOrigin.x = originPos.x
        startOrigin.y = originPos.y
      })

      canvas.addEventListener('mouseup', e => {
        mouseState = 'off'

        if (e.button === 2 && erase) {
          Erase()
        }

        if (e.button === 0 && paint) {
          paintChunk(getChunkFromWorldPos(globalMousePos.x, globalMousePos.y))
        }

        drawGrid()

        console.log('Mouse Up at:', e.clientX, e.clientY)
        console.log('paint ', paint)
      })

      canvas.addEventListener('mousemove', e => {
        document.getElementById('mouseXY').textContent =
          'mouse_local: [' + e.clientX + ', ' + e.clientY + ']'
        document.getElementById('startXY').textContent =
          'start: [' + startX + ', ' + startY + ']'
        document.getElementById('originPosXY').textContent =
          'origin: [' + originPos.x + ', ' + originPos.y + ']'

        globalMousePos.x = e.clientX - originPos.x
        globalMousePos.y = e.clientY - originPos.y

        document.getElementById('globalMousePosXY').textContent =
          'mouse_global: [' + globalMousePos.x + ', ' + globalMousePos.y + ']'

        if (selectedButton.id === 'paint' && mouseState === 'on') {
          paintChunk(getChunkFromWorldPos(globalMousePos.x, globalMousePos.y))
          drawGrid()
          console.log(mouseState)
          return
        }

        if (mouseState === 'on' && move) {
          const deltaX = e.clientX - lastMouse.x
          const deltaY = e.clientY - lastMouse.y

          // this is causing the grid to move 10 in 10 or so
          // need to fix it
          // made this to prevent small movements from triggering panning
          if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
            paint = false
            erase = false

            originPos.x += deltaX
            originPos.y += deltaY

            lastMouse.x = e.clientX
            lastMouse.y = e.clientY

            drawGrid()
          }
        }
      })

      canvas.addEventListener('contextmenu', e => {
        e.preventDefault()
      })

      drawGrid()

      window.addEventListener('resize', drawGrid)
    </script>
  </body>
</html>
